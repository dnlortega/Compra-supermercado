generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Unit {
  UN
  KG
  G
  L
  ML
  PKG
}

// NextAuth Models
model Account {
  id                 String  @id @default(cuid())
  userId             String  @map("user_id")
  type               String
  provider           String
  providerAccountId  String  @map("provider_account_id")
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  accounts      Account[]
  sessions      Session[]
  
  // App Relations
  shoppingLists ShoppingList[]
  catalogProducts CatalogProduct[]
  stores        Store[]
  priceHistory  PriceHistory[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// App Models
model ShoppingList {
  id        String             @id @default(uuid())
  name      String?
  date      DateTime           @default(now())
  status    String             @default("OPEN") // OPEN, COMPLETED
  total     Float              @default(0)
  items     ShoppingListItem[]
  
  userId    String?            @map("user_id")
  user      User?              @relation(fields: [userId], references: [id])
  
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  @@index([status])
  @@index([date(sort: Desc)])
  @@index([userId])
  @@map("shopping_lists")
}

model ShoppingListItem {
  id               String         @id @default(uuid())
  quantity         Float
  unit             Unit           @default(UN)
  unitPrice        Float?         @map("unit_price")
  totalPrice       Float?         @map("total_price")
  checked          Boolean        @default(false)
  
  shoppingListId   String         @map("shopping_list_id")
  shoppingList     ShoppingList   @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  
  catalogProductId String         @map("catalog_product_id")
  catalogProduct   CatalogProduct @relation(fields: [catalogProductId], references: [id])

  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  @@index([shoppingListId])
  @@index([catalogProductId])
  @@index([checked])
  @@map("shopping_list_items")
}

model Category {
  id        String           @id @default(uuid())
  name      String           @unique
  color     String?
  icon      String?
  products  CatalogProduct[]

  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  @@map("categories")
}

model CatalogProduct {
  id                String             @id @default(uuid())
  name              String             @unique
  defaultUnit       Unit               @default(UN) @map("default_unit")
  
  categoryId        String?            @map("category_id")
  category          Category?          @relation(fields: [categoryId], references: [id])
  
  userId            String?            @map("user_id")
  user              User?              @relation(fields: [userId], references: [id])

  shoppingListItems ShoppingListItem[]
  priceHistory      PriceHistory[]

  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  @@index([categoryId])
  @@index([userId])
  @@map("catalog_products")
}

model Store {
  id           String         @id @default(uuid())
  name         String         @unique
  address      String?
  priceHistory PriceHistory[]
  
  userId       String?        @map("user_id")
  user         User?          @relation(fields: [userId], references: [id])

  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  @@index([userId])
  @@map("stores")
}

model PriceHistory {
  id               String         @id @default(uuid())
  unitPrice        Float          @map("unit_price")
  purchaseDate     DateTime       @default(now()) @map("purchase_date")
  
  catalogProductId String         @map("catalog_product_id")
  catalogProduct   CatalogProduct @relation(fields: [catalogProductId], references: [id], onDelete: Cascade)
  
  storeId          String?        @map("store_id")
  store            Store?         @relation(fields: [storeId], references: [id])
  
  userId           String?        @map("user_id")
  user             User?          @relation(fields: [userId], references: [id])

  createdAt        DateTime       @default(now()) @map("created_at")

  @@index([catalogProductId, purchaseDate(sort: Desc)])
  @@index([userId])
  @@map("price_history")
}
